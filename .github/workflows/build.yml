name: Build Workflow
on:
   workflow_dispatch:
      inputs:
         build_type:
            description: 'Build Configuration to use (Debug, Release, RelWithDebInfo or MinSizeRel).'
            required: false
            default: 'Debug'

   push:
      branches:
      - master
      paths-ignore:
      - '**.md'
      - '**/doc'

   pull_request:
      types:
      - opened
      - synchronize
      - reopened
      paths-ignore:
      - '**.md'
      - '**/doc'

jobs:
   Linux-x64:
      name: Linux x64
      runs-on: ubuntu-latest
      container: ubuntu:24.04

      steps:
      -  name: Set build configuration
         id: build_configuration
         run: |
            BUILD_TYPE=${{github.event.inputs.build_type}}
            echo "build_type=${BUILD_TYPE:-"Debug"}" >> $GITHUB_OUTPUT

      -  name: Cache APT packages
         uses: actions/cache@v4
         with:
            path: |
               /var/cache/apt/archives
               /var/lib/apt/lists
            key: ${{ runner.os }}-apt-${{ github.job }}-${{ hashFiles('**/.github/workflows/build.yml') }}
            restore-keys: |
               ${{ runner.os }}-apt-${{ github.job }}-
               ${{ runner.os }}-apt-

      -  name: Setup Dependencies
         run: |
            apt update -y && apt install -y sudo
            sudo apt-get update -y
            sudo apt-get install -y ca-certificates gpg wget
            test -f /usr/share/doc/kitware-archive-keyring/copyright ||
            wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc 2>/dev/null | gpg --dearmor - | sudo tee /usr/share/keyrings/kitware-archive-keyring.gpg >/dev/null
            echo 'deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ noble main' | sudo tee /etc/apt/sources.list.d/kitware.list >/dev/null
            sudo apt-get update -y
            test -f /usr/share/doc/kitware-archive-keyring/copyright ||
            sudo rm /usr/share/keyrings/kitware-archive-keyring.gpg
            sudo apt-get install kitware-archive-keyring
            sudo apt install -y file build-essential cmake ninja-build wget binutils-dev

      -  name: Checkout
         uses: actions/checkout@v4

      -  name: Build
         run: |-
            mkdir ${{steps.build_configuration.outputs.build_type}}
            cd ${{steps.build_configuration.outputs.build_type}}
            cmake -G "Ninja" -DCMAKE_TOOLCHAIN_FILE=../cmake/toolchain-linux-x86_64.cmake -DCMAKE_BUILD_TYPE=${{steps.build_configuration.outputs.build_type}} ..
            cmake --build . --parallel

      -  name: Package
         run: |
            cd ${{steps.build_configuration.outputs.build_type}}
            mkdir -p Artifacts/Linux-x64
            cp le_disasm Artifacts/Linux-x64/

      -  name: Upload Artifacts
         uses: actions/upload-artifact@v4
         with:
            name: ${{github.job}}
            path: ${{steps.build_configuration.outputs.build_type}}/Artifacts

   Windows-x64:
      name: Windows x64
      runs-on: windows-2022

      defaults:
         run:
            shell: msys2 {0}

      steps:
      -  name: Install MSYS2
         uses: msys2/setup-msys2@v2
         with:
            msystem: MINGW64
            update: true
            release: true
            cache: false

      -  name: Set build configuration
         id: build_configuration
         run: |
            BUILD_TYPE=${{github.event.inputs.build_type}}
            echo "build_type=${BUILD_TYPE:-"Debug"}" >> $GITHUB_OUTPUT

      -  name: Setup Dependencies
         run: |
            pacman -S --noconfirm git mingw-w64-x86_64-toolchain mingw-w64-x86_64-cmake mingw-w64-x86_64-ninja mingw-w64-x86_64-binutils mingw-w64-x86_64-zlib mingw-w64-x86_64-zstd mingw-w64-x86_64-gettext-runtime make
            echo "=== Checking for binutils libraries ==="
            ls -la /mingw64/lib/lib*.a | grep -E '(opcodes|bfd|iberty|sframe)' || echo "Static libraries not found in /mingw64/lib"
            echo "=== Files in binutils package ==="
            pacman -Ql mingw-w64-x86_64-binutils | grep '\.a$'

      -  name: Checkout
         uses: actions/checkout@v4

      -  name: Build
         run: |-
            mkdir ${{steps.build_configuration.outputs.build_type}}
            cd ${{steps.build_configuration.outputs.build_type}}
            cmake -G "MSYS Makefiles" -DCMAKE_TOOLCHAIN_FILE=../cmake/toolchain-mingw-w64-x86_64.cmake -DCMAKE_BUILD_TYPE=${{steps.build_configuration.outputs.build_type}} ..
            cmake --build . --parallel

      -  name: Package
         run: |
            cd ${{steps.build_configuration.outputs.build_type}}
            mkdir -p Artifacts/Windows-x64
            cp le_disasm.exe Artifacts/Windows-x64/

      -  name: Upload Artifacts
         uses: actions/upload-artifact@v4
         with:
            name: ${{github.job}}
            path: ${{steps.build_configuration.outputs.build_type}}/Artifacts
            